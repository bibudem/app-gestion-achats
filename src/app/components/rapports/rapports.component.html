<div class="container-fluid bg-white p-4">
  <!-- En-tête -->
  <div class="row mb-4 mt-2">
    <div class="col-md-12 mt-3">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <h1 class="h3 mb-1">{{ 'rapport.titre' | translate }}</h1>
          <p class="text-muted mb-0">{{ 'rapport.description' | translate }}</p>
        </div>
        <div>
          <button type="button" 
                  class="btn btn-outline-secondary me-2"
                  (click)="reinitialiserFiltres()"
                  [disabled]="isLoading">
            <i class="bi bi-arrow-clockwise"></i> {{ 'rapport.reinitialiser' | translate }}
          </button>
          <button type="button" 
                  class="btn btn-success"
                  (click)="exporterRapport()"
                  [disabled]="isLoading || !listeRapport.length">
            <i class="bi bi-file-earmark-excel"></i> {{ 'rapport.exporter' | translate }}
          </button>
        </div>
      </div>
      <hr>
    </div>
  </div>

  <!-- Loading Indicator -->
  <div *ngIf="isLoading" class="text-center py-5">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">{{ 'rapport.chargement' | translate }}</span>
    </div>
    <p class="mt-3 text-muted">{{ 'rapport.chargement-en-cours' | translate }}</p>
  </div>

  <!-- Main Content -->
  <div id="page-rapport" [class.opacity-50]="isLoading">
    
    <!-- Filters Form -->
    <form #rapportForm="ngForm">
      
      <!-- Row 1: Date and Basic Filters -->
      <div class="row g-3 mb-3">
        
        <!-- Date Début -->
        <div class="col-md-2">
          <div class="form-group">
            <label for="dateDebut" class="form-label">
              {{ 'rapport.date-debut' | translate }}
            </label>
            <input type="date" 
                   id="dateDebut"
                   class="form-control" 
                   [(ngModel)]="filtres.dateDebut" 
                   name="dateDebut"
                   [disabled]="isLoading">
          </div>
        </div>

        <!-- Date Fin -->
        <div class="col-md-2">
          <div class="form-group">
            <label for="dateFin" class="form-label">
              {{ 'rapport.date-fin' | translate }}
            </label>
            <input type="date" 
                   id="dateFin"
                   class="form-control" 
                   [(ngModel)]="filtres.dateFin" 
                   name="dateFin"
                   [disabled]="isLoading">
          </div>
        </div>

        <!-- Type Formulaire -->
        <div class="col-md-2">
          <div class="form-group">
            <label for="formulaireType" class="form-label">
              {{ 'rapport.type-formulaire' | translate }}
            </label>
            <select class="form-select form-select-multi"
                    id="formulaireType"
                    name="formulaireType"
                    [(ngModel)]="selectedFormTypes"
                    (change)="onMultiSelectChange('formulaireType', $event)"
                    [disabled]="isLoading"
                    multiple
                    size="1">
              <option *ngFor="let type of typesFormulaires" [value]="type">
                {{ type }}
              </option>
            </select>
            <small class="form-text text-muted" *ngIf="selectedFormTypes.length > 0">
              {{ selectedFormTypes.length }} sélectionné(s)
            </small>
          </div>
        </div>

        <!-- Bibliothèque -->
        <div class="col-md-2">
          <div class="form-group">
            <label for="bibliotheque" class="form-label">
              {{ 'rapport.bibliotheque' | translate }}
            </label>
            <select class="form-select form-select-multi"
                    id="bibliotheque"
                    name="bibliotheque"
                    [(ngModel)]="selectedBibliotheques"
                    (change)="onMultiSelectChange('bibliotheque', $event)"
                    [disabled]="isLoading"
                    multiple
                    size="1">
              <option *ngFor="let bib of bibliotheques" [value]="bib">
                {{ bib }}
              </option>
            </select>
            <small class="form-text text-muted" *ngIf="selectedBibliotheques.length > 0">
              {{ selectedBibliotheques.length }} sélectionné(s)
            </small>
          </div>
        </div>

        <!-- Statut Bibliothèque -->
        <div class="col-md-2">
          <div class="form-group">
            <label for="statutBibliotheque" class="form-label">
              {{ 'rapport.statut-bibliotheque' | translate }}
            </label>
            <select class="form-select form-select-multi"
                    id="statutBibliotheque"
                    name="statutBibliotheque"
                    [(ngModel)]="selectedStatutsBib"
                    (change)="onMultiSelectChange('statutBibliotheque', $event)"
                    [disabled]="isLoading"
                    multiple
                    size="1">
              <option *ngFor="let statut of statutsBibliotheque" [value]="statut">
                {{ statut }}
              </option>
            </select>
            <small class="form-text text-muted" *ngIf="selectedStatutsBib.length > 0">
              {{ selectedStatutsBib.length }} sélectionné(s)
            </small>
          </div>
        </div>

        <!-- Statut Acq -->
        <div class="col-md-2">
          <div class="form-group">
            <label for="statutAcq" class="form-label">
              {{ 'rapport.statut-acq' | translate }}
            </label>
            <select class="form-select form-select-multi"
                    id="statutAcq"
                    name="statutAcq"
                    [(ngModel)]="selectedStatutsAcq"
                    (change)="onMultiSelectChange('statutAcq', $event)"
                    [disabled]="isLoading"
                    multiple
                    size="1">
              <option *ngFor="let statut of statutsAcq" [value]="statut">
                {{ statut }}
              </option>
            </select>
            <small class="form-text text-muted" *ngIf="selectedStatutsAcq.length > 0">
              {{ selectedStatutsAcq.length }} sélectionné(s)
            </small>
          </div>
        </div>
      </div>

      <!-- Row 2: Additional Filters -->
      <div class="row g-3 mb-3">
        
        <!-- Priorité -->
        <div class="col-md-2">
          <div class="form-group">
            <label for="priorite" class="form-label">
              {{ 'rapport.priorite' | translate }}
            </label>
            <select class="form-select form-select-multi"
                    id="priorite"
                    name="priorite"
                    [(ngModel)]="selectedPriorites"
                    (change)="onMultiSelectChange('priorite', $event)"
                    [disabled]="isLoading"
                    multiple
                    size="1">
              <option *ngFor="let p of priorites" [value]="p">
                {{ p }}
              </option>
            </select>
            <small class="form-text text-muted" *ngIf="selectedPriorites.length > 0">
              {{ selectedPriorites.length }} sélectionné(s)
            </small>
          </div>
        </div>

        <!-- Demandeur -->
        <div class="col-md-3">
          <div class="form-group">
            <label for="demandeur" class="form-label">
              {{ 'rapport.demandeur' | translate }}
            </label>
            <input type="text" 
                   id="demandeur"
                   class="form-control" 
                   [(ngModel)]="filtres.demandeur" 
                   name="demandeur"
                   [placeholder]="'rapport.recherche-partielle' | translate"
                   [disabled]="isLoading">
          </div>
        </div>

        <!-- Type Rapport -->
        <div class="col-md-3">
          <div class="form-group">
            <label for="typeRapport" class="form-label">
              {{ 'rapport.type-rapport' | translate }}
            </label>
            <select class="form-select"
                    id="typeRapport"
                    name="typeRapport"
                    [(ngModel)]="rapportSelectionneId"
                    [disabled]="isLoading">
              <option *ngFor="let rapport of rapportsDisponibles" 
                      [value]="rapport.id"
                      [title]="rapport.description">
                {{ rapport.nom }}
              </option>
            </select>
          </div>
        </div>

        <!-- Résultats par page -->
        <div class="col-md-2">
          <div class="form-group">
            <label for="limit" class="form-label">
              {{ 'rapport.resultats-page' | translate }}
            </label>
            <select class="form-select"
                    id="limit"
                    name="limit"
                    [(ngModel)]="limit"
                    (change)="changerLimit(+limit)"
                    [disabled]="isLoading">
              <option [value]="25">25</option>
              <option [value]="50">50</option>
              <option [value]="100">100</option>
              <option [value]="200">200</option>
              <option [value]="500">500</option>
            </select>
          </div>
        </div>

        <!-- Generate Button -->
        <div class="col-md-2 d-flex align-items-end">
          <button type="button" 
                  class="btn btn-primary w-100" 
                  (click)="chargerApercu()"
                  [disabled]="isLoading">
            <i class="bi bi-clipboard2-data-fill"></i> 
            {{ 'rapport.btn-rapport' | translate }}
          </button>
        </div>
      </div>
    </form>

    <!-- Column Selection -->
    <div class="card mb-3">
      <div class="card-header bg-light">
        <h6 class="mb-0">
          <i class="bi bi-columns-gap"></i> 
          {{ 'rapport.selection-colonnes' | translate }}
        </h6>
      </div>
      <div class="card-body">
        <div class="row g-2">
          <div class="col-md-2 col-sm-3 col-6" *ngFor="let champ of champsDisponibles">
            <div class="form-check">
              <input type="checkbox" 
                     class="form-check-input" 
                     [id]="'champ-' + champ" 
                     [value]="champ" 
                     [name]="champ"
                     [checked]="colonnesSelectionnees.includes(champ)"
                     (change)="toggleColonne($event)"
                     [disabled]="isLoading">
              <label class="form-check-label" [for]="'champ-' + champ">
                {{ champsTitre[champ] }}
              </label>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Results Table -->
    <div class="row" *ngIf="!isLoading">
      <div class="col-12">
        
        <!-- Results Summary -->
        <div class="card" *ngIf="dataSource.data.length > 0">
          <div class="card-header bg-dark text-white">
            <div class="d-flex justify-content-between align-items-center">
              <h5 class="mb-0 text-white">
                <i class="bi bi-table"></i> 
                {{ 'rapport.resultats' | translate }}
              </h5>
              <span class="badge bg-light text-dark">
                {{ 'rapport.total-rapport' | translate }}: {{ totalDonnees }}
              </span>
            </div>
          </div>

          <div class="card-body p-0">
            <div class="table-responsive">
              
              <!-- Material Table -->
              <table mat-table
                     [dataSource]="dataSource"
                     class="w-100"
                     matSort>

                <!-- Dynamic Column Definitions -->
                <ng-container *ngFor="let col of colonnesSelectionnees" [matColumnDef]="col">
                  
                  <!-- Header -->
                  <th mat-header-cell 
                      *matHeaderCellDef 
                      mat-sort-header 
                      class="fw-bold bg-light">
                    {{ champsTitre[col] }}
                  </th>

                  <!-- Cell -->
                  <td mat-cell *matCellDef="let row">
                    
                    <!-- Status Badge -->
                    <span *ngIf="isStatusColumn(col)" 
                          [ngClass]="getBadgeClass(row[col])"
                          class="badge">
                      {{ row[col] }}
                    </span>

                    <!-- Priority Badge -->
                    <span *ngIf="isPriorityColumn(col)" 
                          [ngClass]="getPriorityBadgeClass(row[col])"
                          class="badge">
                      {{ row[col] }}
                    </span>

                    <!-- ID Link -->
                    <a *ngIf="col === 'id' || col === 'item_id'" 
                       [routerLink]="['/item', row[col]]"
                       class="text-primary text-decoration-none"
                       [title]="'rapport.consulter-fiche' | translate">
                      <i class="bi bi-link-45deg"></i> {{ row[col] }}
                    </a>

                    <!-- Normal Value -->
                    <span *ngIf="!isStatusColumn(col) && !isPriorityColumn(col) && col !== 'id' && col !== 'item_id'">
                      {{ formatCell(col, row[col]) }}
                    </span>
                  </td>
                </ng-container>

                <!-- Header Row -->
                <tr mat-header-row *matHeaderRowDef="colonnesSelectionnees; sticky: true"></tr>
                
                <!-- Data Rows -->
                <tr mat-row 
                    *matRowDef="let row; columns: colonnesSelectionnees;"
                    class="hover-row"></tr>

                <!-- No Data Row -->
                <tr class="mat-row" *matNoDataRow>
                  <td class="mat-cell text-center py-4" [attr.colspan]="colonnesSelectionnees.length">
                    <i class="bi bi-inbox fs-1 text-muted"></i>
                    <p class="text-muted mt-2">{{ 'rapport.aucune-donnee' | translate }}</p>
                  </td>
                </tr>
              </table>
            </div>

            <!-- Paginator -->
            <mat-paginator [pageSizeOptions]="[25, 50, 100, 200, 500]"
                           [pageSize]="limit"
                           showFirstLastButtons
                           class="border-top">
            </mat-paginator>
          </div>
        </div>

        <!-- Empty State -->
        <div class="card text-center py-5" *ngIf="dataSource.data.length === 0 && !isLoading">
          <div class="card-body">
            <i class="bi bi-search fs-1 text-muted"></i>
            <h5 class="mt-3">{{ 'rapport.aucun-resultat' | translate }}</h5>
            <p class="text-muted">
              {{ 'rapport.aucun-resultat-description' | translate }}
            </p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Hidden Export Table -->
  <table class="d-none" id="table-rapport-export">
    <thead>
      <tr>
        <th *ngFor="let col of colonnesSelectionnees">{{ champsTitre[col] }}</th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let item of listeRapport">
        <td *ngFor="let col of colonnesSelectionnees">{{ formatCell(col, item[col]) }}</td>
      </tr>
    </tbody>
  </table>
</div>